<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Form</title>
  <link rel="stylesheet" href="./form.css">
</head>
<body>
  <div class="container">
    <h1 id="eventTitle">Loading event...</h1>
    <p id="eventDetail">Loading event...</p>
    <div id="error"></div>

    <form id="eventForm" style="display:none;">
      <div id="fieldsContainer"></div>
      <button type="submit">Submit</button>
    </form>
  </div>

  <script>
    const apiBase = "http://localhost:5008/events";
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get("id");

    const eventTitle = document.getElementById("eventTitle");
    const eventDetail = document.getElementById("eventDetail");
    const errorDiv = document.getElementById("error");
    const form = document.getElementById("eventForm");
    const fieldsContainer = document.getElementById("fieldsContainer");

    if (!eventId) {
      errorDiv.textContent = "Invalid event link. Missing ID.";
    } else {
      loadEvent();
    }

    async function loadEvent() {
      try {
        const res = await fetch(`${apiBase}/${eventId}`, {
            method: "GET",
            credentials:"include"
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message || "Failed to load event");
        }

        eventTitle.textContent = data.eventName;
        eventDetail.textContent = data.eventDescription;
        form.style.display = "block";

        if (data.formDescription) {
          const parts = data.formDescription.split("@");
          parts.forEach((part) => {
            const [fieldName, fieldDesc, fieldType] = part.split("->");
            if (fieldName && fieldType) {
              addField(fieldName.trim(), fieldDesc?.trim() || "", fieldType.trim());
            }
          });
        } else {
          fieldsContainer.innerHTML = "<p>No form fields for this event.</p>";
        }

      } catch (err) {
        console.error(err);
        errorDiv.textContent = "Error loading event form.";
      }
    }

    function addField(name, description, type) {
      const div = document.createElement("div");
      div.classList.add("field");

      const label = document.createElement("label");
      label.textContent = `${name}`;
      div.appendChild(label);

      const input = document.createElement("input");
      input.type = type === "phone" ? "tel" : type;
      input.placeholder = description || name;
      input.name = name;
      input.required = true;
      div.appendChild(input);

      fieldsContainer.appendChild(div);
    }
    form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const inputs = form.querySelectorAll("input");
    const responses = [];

    inputs.forEach((input) => {
        responses.push(input.value.trim());
    });

    console.log("Form Responses:", responses);

    try {
        const res = await fetch("http://localhost:5008/events/submitForm", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        credentials: "include", // üîê if you're using cookie auth
        body: JSON.stringify({
            eventId: parseInt(eventId), // comes from the URL param
            formData: responses,
        }),
        });

        const data = await res.json();

        if (!res.ok) {
        throw new Error(data.message || "Form submission failed");
        }

        alert("‚úÖ Form submitted successfully!");
        console.log("Server Response:", data);
        form.reset();
    } catch (err) {
        console.error("‚ùå Submission error:", err);
        alert("Error submitting form: " + err.message);
    }
    });

  </script>
</body>
</html>